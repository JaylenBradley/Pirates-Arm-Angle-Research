# Baseball Pitcher Pose Analysis Pipeline

This pipeline processes baseball pitcher video frames through multiple stages: pose detection → pitcher labeling → angle calculation → results analysis.

## Prerequisites

1. Videos extracted using `extract_video_frames.py` (already done)
2. Frames manually moved to `release_frames/` directories
3. Ground truth CSV file: `~/Desktop/baseball_vids/arm_angles_high_speed.csv`
4. Working ViTPose and MMDetection installation

## Pipeline Overview

```
~/Desktop/baseball_vids/
├── VIDEO_ID/
│   ├── all_frames/          (from extract_video_frames.py)
│   ├── release_frames/      (manually curated frames)
│   ├── poses/               (generated by process_release_frames.py)
│   │   └── frame_XXXX_poses/
│   │       ├── data.json
│   │       └── frame_XXXX_poses.jpg
│   ├── pitcher_labels/      (generated by label_pitchers.py)
│   │   └── frame_XXXX_pitcher/
│   │       ├── data.json
│   │       └── frame_XXXX_pitcher.jpg
│   └── pitcher_calculations/ (generated by calculate_pitcher_angles.py)
│       └── frame_XXXX_angle/
│           ├── data.json
│           └── frame_XXXX_angle.jpg
├── data_analysis/           (generated by analysis scripts)
│   ├── results.csv
│   ├── summary_statistics.csv
│   └── plots/
│       ├── error_distribution_shoulder.png
│       └── error_distribution_elbow.png
└── arm_angles_high_speed.csv
```

## Setup

1. **Copy all Python files to `/Users/jaylen/Developer/Research/Pirates_Arm_Angle/scripts/`:**
   - `pose_utils.py`
   - `process_release_frames.py`
   - `label_pitchers.py`
   - `calculate_pitcher_angles.py`
   - `generate_results_csv.py`
   - `generate_summary_statistics.py`
   - `run_full_pipeline.py`

2. **Place ground truth CSV** at `~/Desktop/baseball_vids/arm_angles_high_speed.csv`

## Quick Start: Master Pipeline Script

The easiest way to run the complete pipeline is using the master script:

```bash
# Run entire pipeline (pose extraction → labeling → angles → CSV)
python scripts/run_full_pipeline.py

# Then generate statistics with plots
python scripts/generate_summary_statistics.py --plot
```

**Master Script Options:**
- `--start-joint shoulder|elbow` - Which joint to use (default: shoulder)
- `--device cpu` - Device for inference
- `--force` - Force reprocessing of all stages
- `--skip-poses` - Skip pose extraction stage
- `--skip-labeling` - Skip pitcher labeling stage
- `--skip-angles` - Skip angle calculation stage
- `--skip-csv` - Skip CSV generation stage

**Examples:**
```bash
# Run with elbow-to-wrist angles
python scripts/run_full_pipeline.py --start-joint elbow

# Skip already-completed stages
python scripts/run_full_pipeline.py --skip-poses --skip-labeling
```

## Detailed Usage (Individual Scripts)

Run from the `Pirates_Arm_Angle` directory (not from scripts/):

### Stage 1: Extract Pose Data

Process all frames in `release_frames/` to detect persons and extract 133 keypoints:

```bash
python scripts/process_release_frames.py
```

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--force` - Reprocess already-processed frames
- `--device cpu` - Device for inference (cpu or cuda:0)

### Stage 2: Label Pitchers (Interactive)

Interactively select which detected person is the pitcher:

```bash
python scripts/label_pitchers.py
```

**Controls:**
- **Click** on a person's image to select them
- **Press 1-9** to select person by number
- **Press 0 or n** to mark "no pitcher detected"
- **Press s** to skip current frame
- **Press q** to quit

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--force` - Reprocess already-labeled frames

### Stage 3: Calculate Angles

Calculate arm angles and compare to ground truth:

```bash
python scripts/calculate_pitcher_angles.py
```

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--csv PATH` - Path to ground truth CSV (default: baseball_vids/arm_angles_high_speed.csv)
- `--start-joint shoulder|elbow` - Joint to start angle from (default: shoulder)
- `--force` - Reprocess already-calculated frames

**To calculate elbow-to-wrist angles instead:**
```bash
python scripts/calculate_pitcher_angles.py --start-joint elbow
```

### Stage 4: Generate Results CSV

Collect all calculated data into a per-frame CSV:

```bash
python scripts/generate_results_csv.py
```

This creates `baseball_vids/data_analysis/results.csv` with columns:
- `video_id`
- `frame_name`
- `pitcher_angle_shoulder_wrist`
- `pitcher_angle_elbow_wrist`
- `ground_truth_angle`

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--output PATH` - Custom output CSV path
- `--force` - Force regeneration

### Stage 5: Generate Summary Statistics (Optional)

Compute overall statistics and generate plots:

```bash
# Generate statistics only
python scripts/generate_summary_statistics.py

# Generate statistics with plots
python scripts/generate_summary_statistics.py --plot

# Customize plots
python scripts/generate_summary_statistics.py --plot --plot-format pdf --bins 30
```

**Statistics calculated:**
- MAE (Closest Prediction)
- MAE (Average Prediction)
- Standard Deviations (Ground Truth, Predictions, Errors)
- % Above/Below Ground Truth
- % Within 3 Degrees
- % Within 8 Degrees

Options:
- `--input PATH` - Input results CSV
- `--output PATH` - Output summary CSV
- `--plot` - Generate error distribution plots
- `--plot-format png|pdf|svg|jpg` - Plot file format
- `--bins NUMBER` - Number of histogram bins (default: 20)
- `--bin-width FLOAT` - Bin width (overrides --bins)
- `--force` - Force regeneration

See **[Results_Analysis_Guide.md](Results_Analysis_Guide.md)** for detailed analysis documentation.

## Output Files

### poses/ - Raw pose detection data
- `data.json`: All detected persons with 133 keypoints each
- `frame_XXXX_poses.jpg`: Visualization with all detected poses

### pitcher_labels/ - Pitcher-specific data
- `data.json`: Selected pitcher's data (person_id, bbox, keypoints)
- `frame_XXXX_pitcher.jpg`: Cropped pitcher image with keypoints

### pitcher_calculations/ - Angle calculations
- `data.json`: Predicted angle, ground truth, error, keypoint positions
- `frame_XXXX_angle.jpg`: Visualization with angle vectors and error

### data_analysis/ - Results and statistics
- `results.csv`: Per-frame results with all angles
- `summary_statistics.csv`: Overall statistics
- `plots/`: Error distribution histograms

## Complete Workflow

### Option 1: Using Master Script (Recommended)

```bash
# 1. Extract frames (if not done)
python scripts/extract_video_frames.py

# 2. Manually move frames from all_frames/ to release_frames/

# 3. Run complete pipeline
python scripts/run_full_pipeline.py

# 4. Generate statistics and plots
python scripts/generate_summary_statistics.py --plot
```

### Option 2: Running Stages Individually

```bash
# 1. Extract frames (if not done)
python scripts/extract_video_frames.py

# 2. Manually move frames from all_frames/ to release_frames/

# 3. Extract pose data
python scripts/process_release_frames.py

# 4. Label pitchers (interactive)
python scripts/label_pitchers.py

# 5. Calculate angles
python scripts/calculate_pitcher_angles.py

# 6. Generate results CSV
python scripts/generate_results_csv.py

# 7. Generate statistics and plots
python scripts/generate_summary_statistics.py --plot
```

### Option 3: Calculate Both Angle Types

```bash
# Run pipeline with shoulder-to-wrist
python scripts/run_full_pipeline.py --start-joint shoulder

# Calculate elbow-to-wrist (reuses existing poses and labels)
python scripts/calculate_pitcher_angles.py --start-joint elbow --force

# Regenerate CSV to include both
python scripts/generate_results_csv.py --force

# Generate statistics
python scripts/generate_summary_statistics.py --plot
```

## Skipping Already-Processed Frames

All scripts automatically skip frames that have already been processed. Each script checks for the existence of the output `data.json` file before processing.

To force reprocessing:
```bash
python scripts/process_release_frames.py --force
python scripts/label_pitchers.py --force
python scripts/calculate_pitcher_angles.py --force
python scripts/generate_results_csv.py --force
python scripts/generate_summary_statistics.py --force
```

## No Pitcher Detected

If you mark a frame as "no pitcher detected" in Stage 2:
- A minimal JSON is created in `pitcher_labels/`
- Stage 3 automatically skips these frames
- They won't appear in results CSV
- They won't affect error calculations or statistics

## Troubleshooting

**"Poses data not found" in Stage 2:**
- Run Stage 1 first: `python scripts/process_release_frames.py`

**"Pitcher labels not found" in Stage 3:**
- Run Stage 2 first: `python scripts/label_pitchers.py`

**"No ground truth found for video":**
- Make sure video ID in baseball_vids matches PitchId in CSV
- Check CSV path: `~/Desktop/baseball_vids/arm_angles_high_speed.csv`

**"No calculated frame data found" in CSV generation:**
- Run Stage 3 first: `python scripts/calculate_pitcher_angles.py`

**"Input CSV not found" in statistics generation:**
- Run Stage 4 first: `python scripts/generate_results_csv.py`

**Import errors:**
- Make sure you're running from `Pirates_Arm_Angle` directory (not scripts/)
- Check that `pose_utils.py` is in the scripts/ directory
- Ensure ViTPose and MMDetection are installed

**Matplotlib errors when plotting:**
- Install matplotlib: `pip install matplotlib` or `conda install matplotlib`

## Notes

- All scripts process ALL videos in baseball_vids automatically
- Only frames in `release_frames/` are processed (manually curated)
- Frame naming follows pattern: `frame_XXXX → frame_XXXX_poses → frame_XXXX_pitcher → frame_XXXX_angle`
- CSV PitcherHand (R/L) determines which arm to analyze
- Default angle calculation is shoulder-to-wrist (use `--start-joint elbow` for elbow-to-wrist)
- Results CSV merges shoulder and elbow calculations for frames where both exist
- Statistics are calculated separately for shoulder-wrist and elbow-wrist angles

## Additional Resources

- **[Video_Extraction_Instructions.md](Video_Extraction_Instructions.md)**: Guide for extracting frames from videos
- **[Results_Analysis_Guide.md](Results_Analysis_Guide.md)**: Detailed guide for results analysis scripts and interpretation
